var TimeKnots={draw:function(e,f,g){var h={width:600,height:200,radius:10,lineWidth:4,color:"#999",background:"#FFF",dateFormat:"%Y/%m/%d %H:%M:%S",horizontalLayout:true,showLabels:false,labelFormat:"%Y/%m/%d %H:%M:%S"};if(g!=undefined){for(var i in g){h[i]=g[i]}}var j=d3.select(e).append('div').style("opacity",0).style("position","absolute").style("font-family","Helvetica Neue").style("font-weight","300").style("background","rgba(0,0,0,0.5)").style("color","white").style("padding","5px 10px 5px 10px").style("-moz-border-radius","8px 8px").style("border-radius","8px 8px");var k=d3.select(e).append('svg').attr("width",h.width).attr("height",h.height);var l=f.map(function(d){return Date.parse(d.date)});var m=d3.max(l);var n=d3.min(l);var o=(d3.max(f.map(function(d){return d.radius}))||h.radius)*1.5+h.lineWidth;var p=(h.horizontalLayout)?((h.width-2*o)/(m-n)):((h.height-2*o)/(m-n));if(m==n){p=0;if(h.horizontalLayout){o=h.width/2}else{o=h.height/2}}k.append("line").attr("class","timeline-line").attr("x1",function(d){if(h.horizontalLayout){return(o)}return Math.floor(h.width/2)}).attr("x2",function(d){if(h.horizontalLayout){return(h.width-o)}return Math.floor(h.width/2)}).attr("y1",function(d){if(h.horizontalLayout){return Math.floor(h.height/2)}return o}).attr("y2",function(d){if(h.horizontalLayout){return Math.floor(h.height/2)}return h.height-o}).style("stroke",h.color).style("stroke-width",h.lineWidth);k.selectAll("circle").data(f).enter().append("circle").attr("class","timeline-event").attr("r",function(d){if(d.radius!=undefined){return d.radius}return h.radius}).style("stroke",function(d){if(d.color!=undefined){return d.color}return h.color}).style("stroke-width",function(d){if(d.lineWidth!=undefined){return d.lineWidth}return h.lineWidth}).style("fill",function(d){if(d.background!=undefined){return d.background}return h.background}).attr("cy",function(d){if(h.horizontalLayout){return Math.floor(h.height/2)}return Math.floor(p*(new Date(d.date).getTime()-n)+o)}).attr("cx",function(d){if(h.horizontalLayout){var x=Math.floor(p*(new Date(d.date).getTime()-n)+o);return x}return Math.floor(h.width/2)}).on("mouseover",function(d){var a=d3.time.format(h.dateFormat);var b=a(new Date(d.date));var c=(b!="")?(d.name+" <small>("+b+")</small>"):d.name;d3.select(this).style("fill",function(d){if(d.color!=undefined){return d.color}return h.color}).transition().duration(100).attr("r",function(d){if(d.radius!=undefined){return Math.floor(d.radius*1.5)}return Math.floor(h.radius*1.5)});j.html("");if(d.img!=undefined){j.append("img").style("float","left").style("margin-right","4px").attr("src",d.img).attr("width","64px")}j.append("div").style("float","left").html(c);j.transition().duration(100).style("opacity",.9)}).on("mouseout",function(){d3.select(this).style("fill",function(d){if(d.background!=undefined){return d.background}return h.background}).transition().duration(100).attr("r",function(d){if(d.radius!=undefined){return d.radius}return h.radius});j.transition().duration(100).style("opacity",0)});if(h.showLabels!=false){var q=d3.time.format(h.labelFormat);var r=q(new Date(n));var s=q(new Date(m));k.append("text").text(r).style("font-size","70%").attr("x",function(d){if(h.horizontalLayout){return d3.max([0,(o-this.getBBox().width/2)])}return Math.floor(this.getBBox().width/2)}).attr("y",function(d){if(h.horizontalLayout){return Math.floor(h.height/2+(o+this.getBBox().height))}return o+this.getBBox().height/2});k.append("text").text(s).style("font-size","70%").attr("x",function(d){if(h.horizontalLayout){return h.width-d3.max([this.getBBox().width,(o+this.getBBox().width/2)])}return Math.floor(this.getBBox().width/2)}).attr("y",function(d){if(h.horizontalLayout){return Math.floor(h.height/2+(o+this.getBBox().height))}return h.height-o+this.getBBox().height/2})}k.on("mousemove",function(){tipPixels=parseInt(j.style("height").replace("px",""));return j.style("top",(d3.event.pageY-tipPixels-o)+"px").style("left",(d3.event.pageX+20)+"px")}).on("mouseout",function(){return j.style("opacity",0).style("top","0px").style("left","0px")})}}
